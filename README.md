# Software requirements specification
## Терминология
1. Бот - Django-приложение, которое взаимодействует с сервером телеграма.
1. Идентификатор доступа (карточки, QR-коды) - объект, который может быть использован для идентификации пользователя и предоставления ему доступа в определенные помещения.
1. СКУД (система контроля и управления доступа) - сервис, который принимает решение о разрешении/запрете доступа пользователя к помещениям или объектам.


## Описание

Данный бот необходим для упрощенного взаимодействия с ПО Департамента безопасности Университета ИТМО.

Бот позволяет авторизованным пользователям управлять своими идентификаторами (просматривать, блокировать/разблокировать), получать QR-код.

В дальнейшем планируется расширение функциональности, добавление других функции ПО в бота.

Спектр работ:

1. Реализовать телеграм бота в виде отдельного микросервиса.
1. Написать соотвутствующие эндпоинты для сервера СКУДа:
    1. Получение идентификаторов доступа пользователя
    1. Управление статусами идентификаторов доступа
    1. Получение QR-кода пользователя


## Функциональные требования

1. Пользователь должен иметь возможность аутентифицироваться в боте через сервер СКУДа, чтобы обеспечить безопасность и контроль доступа к функционалу бота.

    Необходимо реализовать OIDC аутентификацию с помощью SSO Keycloak.

    Флоу аутентификации:
    1. Пользователь отправляет запрос на сервер бота для получения ссылки - переходя по этой ссылке, пользователь вводит логин и пароль в браузере на странице аутентификации Keycloak.
    1. Keycloak отправляет боту Authorization Code.
    1. Бот отправляет Authorization Code и свои секреты для получения токенов доступа.
    1. Keycloak отправляет боту access и refresh-токены пользователя. Токены хранятся в базе данных бота.
    1. Каждый раз, когда пользователь делает запрос (например, на получение своих идентификаторов) сервер бота отправляет запрос в СКУД вместе с access-токеном.

    В случае, если refresh-токен истек, пользователь бота заново получает ссылку, по которой необходимо залогиниться.

1. Бот должен хранить пользователей в базе данных и логировать все действия пользователя.
1. Пользователь должен иметь возможность получать изображение своего QR-кода.
1. Пользователь должен иметь возможность управлять своими идентификаторами доступа:
    1. Пользователь может просмотреть свои идентификаторы
    1. Пользователь может сделать идентификатор активным/неактивным

5. Бот должен быть расширяемым, так как в будущем будет производиться работа по добавлению функционала.

    В базе должны храниться Workflow, которые представляют конечные действия в боте (получить QR-код, сделать идентификатор неактивным, просмотреть идентификаторы).

    Workflow должен состоять из определенных действий - WorkflowItem.

    Пример. “сделать идентификатор неактивным”: вывести все идентификаторы -> принять выбор идентификатора от пользователя -> вывести текст “заблокировать идентификатор?” -> принять выбор от пользователя -> выполнить действие и вернуться в начало.

    В базе хранится указатель на текущий WorkflowItem – состояние пользователя бота.

## Нефункциональные требования
1. Бот должен иметь интуитивно понятный интерфейс, построенный на KeyboardButton и InlineKeyboardButton – кнопки, меню.
1. Бот должен определять команды (как минимум /start и /help), которые должны быть отражены в меню бота.
1. Сообщения, отправляемые ботом, должны быть информативными и удобочитаемыми для пользователей.
1. Текст сообщений бота должен храниться в базе данных, а не указан напрямую в коде, чтобы обеспечить возможность легкого изменения и локализации текстов.
1. Должны использоваться актуальные версии библиотек и фреймворков.

## Архитектурные требования
1. Бот представляет собой микросервис, который должен быть реализован на базе Django-приложения + rest framework.
1. Получение обновлений из телеграм должно быть реализовано с помощью вебхуков.
1. Для хранения данных необходимо использовать базу данных PostgreSQL.
1. В случае необходимости обеспечения асинхронной обработки задач необходимо использовать Celery + Redis.
1. Приложение должно запускаться внутри Docker контейнеров с помощью docker-compose.


## TL;DR
### Структура
- [Файл](telegram_bot/locale.yaml) с локализацией сообщений
- [Документация](telegram_bot/workflow/README.md) на добавления новых команд и workflow

### Переменные окружения
Должны быть заданы следующие переменные для docker compose

Общие:
- TELEGRAM_BOT_TOKEN

База данных:
- POSTGRES_USER
- POSTGRES_PASSWORD
- POSTGRES_NAME

Сервер аутентификации:
- KEYCLOAK_REALM_URL
- KEYCLOAK_CLIENT_ID
- KEYCLOAK_CLIENT_SECRET
- KEYCLOAK_REDIRECT_URL

### Запуск
```sh
docker-compose build
docker-compose run django migrate
docker-compose run django genlocale
docker-compose run django createsuperuser
docker-compose up
```
